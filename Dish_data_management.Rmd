---
title: "DISH Data Management"
author: "Ricki Runions"
date: "May 17, 2024"
output: word_document
---

This notebook preps and manages data for the DISH survey. 

#***Import and Prep Data***
##Prepare R Environment
```{r message=FALSE, warning=FALSE, include=FALSE}

#clear R environment
rm(list = ls())

#load required packages
library(dplyr)
library(tidyr)
library(rio)
library(ggplot2)
library(ggthemes)
library(grafify)
library(lubridate)
library(stringr)
library(XLConnect)
library(flextable)
library(gtsummary)
library(writexl)
library(forcats)
library(openxlsx)



```

##Import the data
```{r include=FALSE}

df.survey <- read.csv( "/Users/ricki/Desktop/DISH_data_cleaning/Output/survey_clean_for_management_280824.csv") %>%
    select(-X)
  
  df.intake24_item <- read.csv("/Users/ricki/Desktop/DISH_data_cleaning/Output/intake24_clean_for_management_280824.csv") %>%
    select(-X)
  
  user_char <- read.csv("/Users/ricki/Desktop/DISH_data_cleaning/Output/user_characteristics_280824.csv") %>%
    select(-X)
```

```{r }
  # Keep variables needed for analysis ####
df.intake24_item <- df.intake24_item %>%
  select(SurveyID,UserID,HouseholdID, Sex, Ethnicity, Age, CalcAge, age_cat, simd_quintile, SurveyDuration,date,RecallNo,NumberOfRecalls,NumberOfItems,FoodAmount,FoodAmountReason,NewMealName,NewMealTime,MealTime_hour,MealTime_minute,FoodSource,SearchTerm,FoodID,Intake24FoodCode,Description_English,Description_Local,FoodGroupCode,FoodGroupEnglish,SubFoodGroupCode,ReadyMeal,TotalGrams,MissingFoodID,MissingFoodDescription,MissingFoodPortionSize,MissingFoodLeftovers,Energykcal,Proteing,Fatg,Saturatedfattyacidsg,Transfattyacidsg,Carbohydrateg,Alcoholg,Totalsugarsg,TOTALFS,AOACg,Sodiummg,VitaminAug,Riboflavinmg,Folateug,VitaminDug,VitaminB12ug,VitaminCmg,Ironmg,Calciummg,Iodineug,Magnesiummg,Potassiummg,Seleniumug,Zincmg,Fruitg,FruitJuiceg,DriedFruitg,SmoothieFruitg,Tomatoesg,TomatoPureeg,Brassicaceaeg,YellowRedGreeng,Beansg,Nutsg,OtherVegg,Beefg,Lambg,Porkg,ProcessedRedMeatg,OtherRedMeatg,Burgersg,Sausagesg,Offalg,Poultryg,ProcessedPoultryg,GameBirdsg,WhiteFishg,OilyFishg,CannedTunag,Shellfishg, NutrientTableCode) 
```


##Convert variables to numeric and remove NAs
```{r include=FALSE}
#convert to numeric from characters

# List of variables to not convert
    char_not_to_convert <- c("SurveyID", "UserID","HouseholdID", "SurveyDuration", "date", "Ethnicity","Sex", "CalcAge", "age_cat", "FoodAmount", "FoodAmountReason", "NewMealName", "NewMealTime", "FoodSource", "SearchTerm", "Intake24FoodCode", "Description_English", "Description_Local", "FoodGroupCode", "FoodGroupEnglish", "SubFoodGroupCode", "ReadyMeal",  "MissingFoodID", "MissingFoodDescription", "MissingFoodPortionSize", "MissingFoodLeftovers")
    
    df.intake24_item <- df.intake24_item %>%
      mutate(across(-all_of(char_not_to_convert), as.numeric))
    
  # Change NA values to 0
    df.intake24_item <- df.intake24_item %>%
      mutate_all(~ifelse(is.na(.), 0, .))
```

#Create Main Food Groups
```{r}
df.intake24_item <- df.intake24_item %>%
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode %in% c("1C", "1D", "1E", "1F", "1G", "1R") ~ 1,
        SubFoodGroupCode=="2R" ~ 2,
        SubFoodGroupCode=="3R" ~ 3,
        SubFoodGroupCode=="59R" ~ 59,
        SubFoodGroupCode %in% c("4A", "4R") ~ 4,
        SubFoodGroupCode=="5R" ~ 5,
        SubFoodGroupCode=="6R" ~ 6,
        SubFoodGroupCode %in% c("7A", "7B") ~ 7,
        SubFoodGroupCode %in% c("8B", "8C", "8D", "8E") ~ 8,
        SubFoodGroupCode %in% c("9C", "9D", "9E", "9F", "9G", "9H") ~ 9,
        SubFoodGroupCode=="10R" ~ 10,
        SubFoodGroupCode=="11R" ~ 11,
        SubFoodGroupCode=="60R" ~ 60,
        SubFoodGroupCode=="12R" ~ 12,
        SubFoodGroupCode %in% c("13A", "13B", "13R") ~ 13,
        SubFoodGroupCode %in% c("14A", "14B", "14R") ~ 14,
        SubFoodGroupCode %in% c("15B", "15C", "15D") ~ 15,
        SubFoodGroupCode=="53R" ~ 53,
        SubFoodGroupCode %in% c("16C", "16D") ~ 16,
        SubFoodGroupCode=="17R" ~ 17,
        SubFoodGroupCode %in% c("18A", "18B") ~ 18,
        SubFoodGroupCode %in% c("19A", "19R") ~ 19,
        SubFoodGroupCode %in% c("20A", "20B", "20C") ~ 20,
        SubFoodGroupCode %in% c("21A", "21B") ~ 21,
        SubFoodGroupCode %in% c("22A", "22B") ~ 22,
        SubFoodGroupCode %in% c("23A", "23B") ~ 23,
        SubFoodGroupCode %in% c("24A", "24B") ~ 24,
        SubFoodGroupCode %in% c("25A", "25B") ~ 25,
        SubFoodGroupCode %in% c("26A", "26B") ~ 26,
        SubFoodGroupCode %in% c("27A", "27B") ~ 27,
        SubFoodGroupCode=="28R" ~ 28,
        SubFoodGroupCode=="29R" ~ 29,
        SubFoodGroupCode %in% c("30A", "30B") ~ 30,
        SubFoodGroupCode %in% c("31A", "31B") ~ 31,
        SubFoodGroupCode %in% c("32A", "32B") ~ 32,
        SubFoodGroupCode=="33R" ~ 33,
        SubFoodGroupCode %in% c("34C", "34D", "34E", "34F", "34G", "34H") ~ 34,
        SubFoodGroupCode %in% c("35A", "35B") ~ 35,
        SubFoodGroupCode %in% c("36A", "36B", "36C") ~ 36,
        SubFoodGroupCode %in% c("37A", "37B", "37C", "37D", "37E", "37F", "37I", "37K", "37L", "37M") ~ 37,
        SubFoodGroupCode %in% c("38A", "38C", "38D") ~ 38,
        SubFoodGroupCode %in% c("39A", "39B") ~ 39,
        SubFoodGroupCode=="42R" ~ 42,
        SubFoodGroupCode=="56R" ~ 56,
        SubFoodGroupCode %in% c("40A", "40B", "40C", "40D", "40E", "40R") ~ 40,
        SubFoodGroupCode  %in% c("41A", "41B", "41R") ~ 41,
        SubFoodGroupCode=="43R" ~ 43,
        SubFoodGroupCode=="44R" ~ 44,
        SubFoodGroupCode  %in% c("45R", "61R") ~ 45,
        SubFoodGroupCode %in% c("57A", "57B", "57C") ~ 57,
        SubFoodGroupCode %in% c("58A", "58B", "58C") ~ 58,
        SubFoodGroupCode %in% c("51A", "51B", "51C", "51D", "51R") ~ 51,
        SubFoodGroupCode %in% c("47A", "47B") ~ 47,
        SubFoodGroupCode %in% c("48A", "48B", "48C") ~ 48,
        SubFoodGroupCode %in% c("49A", "49B", "49C", "49D", "49E") ~ 49,
        SubFoodGroupCode %in% c("50A", "50C", "50D", "50E", "50R") ~ 50,
        SubFoodGroupCode %in% c("52A", "52R") ~ 52,
        SubFoodGroupCode %in% c("54A", "54B", "54C", "54D", "54E", "54F", "54G", "54H", "54I", "54J", "54K", "54L", "54M", "54N", "54P") ~ 54,
        SubFoodGroupCode=="55R" ~ 55,
        SubFoodGroupCode=="62R" ~ 62,
        TRUE ~ NA)) %>%
        relocate(MainFoodGroupCode, .after = FoodGroupEnglish)
```


##Remove dairy-free items from milk product sub food groups
```{r}
#Sub food group level
    # Other milk
    df.intake24_item <- df.intake24_item %>%  
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "13R" &
            (str_detect(Description_English, regex("Almond", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Alpro", ignore_case = TRUE)) |
             str_detect(Description_English, regex("soya", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Hemp", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Oat", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Rice", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Coconut", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Dairy free", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Hazelnut", ignore_case = TRUE))) ~ "13R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Cream
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "13B" & 
          str_detect(Description_English, regex("Alpro", ignore_case = TRUE)) ~ "13B_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Other cheese
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "14R" & 
          (str_detect(Description_English, regex("Tofu", ignore_case = TRUE))|
          str_detect(Description_English, regex("Coconut", ignore_case = TRUE))) ~ "14R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Yogurt
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "15B" & 
          (str_detect(Description_English, regex("Soya", ignore_case = TRUE)) | 
           str_detect(Description_English, regex("Coconut", ignore_case = TRUE)) |
           str_detect(Description_English, regex("oat", ignore_case = TRUE))  ) ~ "15B_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Fromage frais and other dairy desserts 
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "15C" & 
          str_detect(Description_English, regex("Soya", ignore_case = TRUE)) ~ "15C_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Ice cream
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "53R" &
          str_detect(Description_English, regex("Dairy free", ignore_case = TRUE)) ~ "53R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Main food group level
    df.intake24_item <- df.intake24_item %>% 
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode == "13R_DF" ~ 63,
        SubFoodGroupCode == "13B_DF" ~ 63,
        SubFoodGroupCode == "14R_DF" ~ 64,
        SubFoodGroupCode == "15B_DF" ~ 65,
        SubFoodGroupCode == "15C_DF" ~ 65,
        SubFoodGroupCode == "53R_DF" ~ 66,
        TRUE ~ MainFoodGroupCode))
    
```


##Remove hot chocolate made with water
```{r}
# Sub food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        str_detect(Description_English, regex("Hot chocolate, made with water", ignore_case=TRUE)) ~ "50A",
        TRUE ~ SubFoodGroupCode)) 
    
    # Main food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode == "50A" ~ 50,
        TRUE ~ MainFoodGroupCode))


    # Move milky coffees into 'other milk'
    
    #Sub food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "51A" &
          (str_detect(Description_English, regex("Cappuccino", ignore_case = TRUE)) | 
             str_detect(Description_English, regex("Latte", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Flat white", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Mocha", ignore_case = TRUE))) ~ "13R",
        TRUE ~ SubFoodGroupCode))
```

##Re-categorise dairy-free coffees out of 'other milk'
```{r}
# Sub food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "13R" &
          str_detect(Description_English, regex("soya milk", ignore_case = TRUE)) ~ "13R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Main food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode == "13R" ~ 13,
        TRUE ~ MainFoodGroupCode))
    
    #Manual code check: for dairy-free items
    df.dairy_free <- df.intake24_item %>% 
      filter(SubFoodGroupCode == "13R" | SubFoodGroupCode == "13B" | SubFoodGroupCode == "14R" | SubFoodGroupCode == "15B" | SubFoodGroupCode == "15C" | SubFoodGroupCode == "53R")  
    df.dairy_free <- df.dairy_free %>% distinct(Description_English, .keep_all = TRUE)  
  
rm(df.dairy_free)
    
```

#Create Main Food Group Descriptions
```{r}
# Create Main Food Group description variable
    df.intake24_item <- df.intake24_item %>%
      mutate(MainFoodGroupDesc = case_when(
        MainFoodGroupCode == 1 ~ "Pasta, rice and other miscellaneous cereals",
        MainFoodGroupCode == 2 ~ "White bread",
        MainFoodGroupCode == 3 ~ "Wholemeal bread",
        MainFoodGroupCode == 4 ~ "Other breads",
        MainFoodGroupCode == 5 ~ "High fibre breakfast cereals",
        MainFoodGroupCode == 6 ~ "Other breakfast cereals",
        MainFoodGroupCode == 7 ~ "Biscuits",
        MainFoodGroupCode == 8 ~ "Buns, cakes, pastries and fruit pies",
        MainFoodGroupCode == 9 ~ "Puddings",
        MainFoodGroupCode == 10 ~ "Whole milk",
        MainFoodGroupCode == 11 ~ "Semi-skimmed milk",
        MainFoodGroupCode == 12 ~ "Skimmed milk",
        MainFoodGroupCode == 13 ~ "Other milk and cream",
        MainFoodGroupCode == 14 ~ "Cheese",
        MainFoodGroupCode == 15 ~ "Yogurt, fromage frais and other dairy desserts",
        MainFoodGroupCode == 16 ~ "Eggs and egg dishes",
        MainFoodGroupCode == 17 ~ "Butter",
        MainFoodGroupCode == 18 ~ "Polyunsaturated margarine and oils",
        MainFoodGroupCode == 19 ~ "Low fat spread",
        MainFoodGroupCode == 20 ~ "Margarine and other cooking fats and oils NOT polyunsaturated",
        MainFoodGroupCode == 21 ~ "Reduced fat spread",
        MainFoodGroupCode == 22 ~ "Bacon and ham",
        MainFoodGroupCode == 23 ~ "Beef, veal and dishes",
        MainFoodGroupCode == 24 ~ "Lamb and dishes",
        MainFoodGroupCode == 25 ~ "Pork and dishes",
        MainFoodGroupCode == 26 ~ "Coated chicken and turkey manufactured",
        MainFoodGroupCode == 27 ~ "Chicken and turkey dishes",
        MainFoodGroupCode == 28 ~ "Liver, products and dishes",
        MainFoodGroupCode == 29 ~ "Burgers and kebabs",
        MainFoodGroupCode == 30 ~ "Sausages",
        MainFoodGroupCode == 31 ~ "Meat pies and pastries",
        MainFoodGroupCode == 32 ~ "Other meat and meat products",
        MainFoodGroupCode == 33 ~ "White fish coated or fried",
        MainFoodGroupCode == 34 ~ "Other white fish, shellfish and fish dishes",
        MainFoodGroupCode == 35 ~ "Oily fish",
        MainFoodGroupCode == 36 ~ "Salad and other raw vegetables",
        MainFoodGroupCode == 37 ~ "Vegetables (not raw)",
        MainFoodGroupCode == 38 ~ "Chips, fried and roast potatoes and potato products",
        MainFoodGroupCode == 39 ~ "Other potatoes, potato salads and dishes",
        MainFoodGroupCode == 40 ~ "Fruit",
        MainFoodGroupCode == 41 ~ "Sugars, preserves and sweet spreads",
        MainFoodGroupCode == 42 ~ "Crisps and savoury snacks",
        MainFoodGroupCode == 43 ~ "Sugar confectionery",
        MainFoodGroupCode == 44 ~ "Chocolate confectionery",
        MainFoodGroupCode == 45 ~ "Fruit juice",
        MainFoodGroupCode == 47 ~ "Spirits and liqueurs",
        MainFoodGroupCode == 48 ~ "Wine",
        MainFoodGroupCode == 49 ~ "Beer lager cider and perry",
        MainFoodGroupCode == 50 ~ "Miscellaneous",
        MainFoodGroupCode == 51 ~ "Tea, coffee and water",
        MainFoodGroupCode == 52 ~ "Commercial toddlers foods and drinks",
        MainFoodGroupCode == 53 ~ "Ice cream",
        MainFoodGroupCode == 54 ~ "Dietary supplements",
        MainFoodGroupCode == 55 ~ "Artificial sweeteners",
        MainFoodGroupCode == 56 ~ "Nuts and seeds",
        MainFoodGroupCode == 57 ~ "Soft drinks, not diet",
        MainFoodGroupCode == 58 ~ "Soft drinks, diet",
        MainFoodGroupCode == 59 ~ "Brown, granary and wheatgerm bread",
        MainFoodGroupCode == 60 ~ "1% Milk",
        MainFoodGroupCode == 62 ~ "Sandwiches",
        MainFoodGroupCode == 63 ~ "Other milk and cream DF",                          ####DF descriptions
        MainFoodGroupCode == 64 ~ "Cheese DF",
        MainFoodGroupCode == 65 ~ "Yogurt, fromage frais and other dairy desserts DF",
        MainFoodGroupCode == 66 ~ "Ice cream DF",
        TRUE ~ NA)) %>%
      relocate(MainFoodGroupDesc, .after = MainFoodGroupCode)
```

```{r eval=FALSE, include=FALSE}
 # Check of updated descriptions
    df.intake24_item %>%
      filter(MainFoodGroupCode %in% c(63,64,65,66))%>%
      View()
    
    df.intake24_item %>%
      filter(MainFoodGroupCode == 50)%>%
      View()
```

##Remove Diet Supplements and Breast Milk
```{r}
# Remove diet supplements
  df.intake24_item <- df.intake24_item %>%
      filter(MainFoodGroupCode != 54)
    
# Remove breast milk 
  df.intake24_item <- df.intake24_item %>%
      filter(Description_English != "Breast milk") 
```




#Create new nutrient variables
```{r}
# Create food energy (kcal) variable
    df.intake24_item <- df.intake24_item %>%
      mutate(FoodEnergy = Energykcal - (Alcoholg*7)) %>%
      relocate(FoodEnergy, .after = Energykcal)
    
    # Create food energy milk (kcal) variable - removes all kcals from non-milk beverages
    df.intake24_item <- df.intake24_item %>%                
      mutate(FoodEnergyMilk = case_when(
        MainFoodGroupCode %in% c(45, 51, 57, 58) ~  0,
        TRUE ~ FoodEnergy)) %>%
      relocate(FoodEnergyMilk, .after = FoodEnergy)
    
  # Create food grams variable
    df.intake24_item <- df.intake24_item %>%
      mutate(FoodGrams = TotalGrams - Alcoholg) %>%
      relocate(FoodGrams, .after = TotalGrams)
    
  # Create food grams milk variable
    df.intake24_item <- df.intake24_item %>%                
      mutate(FoodGramsMilk = case_when(
        FoodEnergyMilk == 0 ~ 0,
        TRUE ~ FoodGrams
      )) %>%
      relocate(FoodGramsMilk, .after = FoodGrams)
```

##Calculate intakes as a percent of calories and calculate salt from sodium
```{r}
 # Calculate intakes as percent of calories (kcal)
    df.intake24_item <- df.intake24_item %>%
      mutate(
        Carbs_kcal = (Carbohydrateg*3.75),
        TotalSugars_kcal = (TOTALFS*3.75), 
        Fat_kcal = (Fatg*9),
        SatFat_Kcal = (Saturatedfattyacidsg*9),
        TransFat_Kcal = (Transfattyacidsg*9)) %>%
        relocate(Carbs_kcal, .after = Carbohydrateg) %>%
        relocate(TotalSugars_kcal, .after = TOTALFS) %>%
        relocate(Fat_kcal, .after = Fatg) %>%
        relocate(SatFat_Kcal, .after = Saturatedfattyacidsg) %>%
        relocate(TransFat_Kcal, .after = Transfattyacidsg)

        
  # Calculate salt from sodium 
    df.intake24_item <- df.intake24_item %>%
      mutate(
        Saltg = ((Sodiummg/1000)*2.498)
      ) %>%
      relocate(Saltg, .after = Sodiummg)
```


#Recall Level Dataset
##Calculate mean daily intakes of nutrients
```{r}
# Recall level
  df.intake24_recall <- df.intake24_item %>% 
      group_by(UserID, RecallNo) %>%
      summarise(
        HouseholdID = first(HouseholdID),
        Sex = first(Sex),
        Ethnicity = first(Ethnicity),
        Age = first(Age),
        CalcAge = first(CalcAge), 
        age_cat = first(age_cat),
        simd_quintile = first(simd_quintile),
        NumberOfRecalls = first(NumberOfRecalls), 
        Day_Energykcal = sum(Energykcal),
        Day_FoodEnergy = sum(FoodEnergy),
        Day_FoodEnergyMilk = sum(FoodEnergyMilk),
        Day_FoodGrams = sum(FoodGrams),
        Day_FoodGramsMilk = sum(FoodGramsMilk),
        Day_Carbohydrate = sum(Carbohydrateg),
        Day_Carbs_kcal=sum(Carbs_kcal),
        Day_TotalSugars = sum(TOTALFS), 
        Day_TotalSugars_kcal=sum(TotalSugars_kcal),
        Day_TotalFatg = sum(Fatg),
        Day_Fat_kcal=sum(Fat_kcal),
        Day_SatFatg = sum(Saturatedfattyacidsg),
        Day_SatFat_Kcal=sum(SatFat_Kcal),
        Day_TransFatg = sum(Transfattyacidsg),
        Day_TransFat_Kcal=sum(TransFat_Kcal),
        Day_Protein = sum(Proteing),
        Day_AOACFibre = sum(AOACg),
        Day_VitaminA = sum(VitaminAug),
        Day_Riboflavin = sum(Riboflavinmg),
        Day_Folate = sum(Folateug),
        Day_VitaminD = sum(VitaminDug),
        Day_VitaminB12 = sum(VitaminB12ug),
        Day_VitaminC = sum(VitaminCmg),
        Day_Iron = sum(Ironmg),
        Day_Calcium = sum(Calciummg),
        Day_Sodium = sum(Sodiummg),
        Day_Salt = sum(Saltg), #salt
        Day_Iodine = sum(Iodineug),
        Day_Magnesium = sum(Magnesiummg),
        Day_Potassium = sum(Potassiummg),
        Day_Selenium = sum(Seleniumug),
        Day_Zinc = sum(Zincmg)) %>%
      ungroup() 
```

##Intakes as a percentage of food energy
```{r}
df.intake24_recall <- df.intake24_recall %>%
      mutate(
        Day_Carbs_PropFoodEnergy = (Day_Carbs_kcal/Day_FoodEnergy)*100,
        Day_TotalSugars_PropFoodEnergy = (Day_TotalSugars_kcal/Day_FoodEnergy)*100,
        Day_Fat_PropFoodEnergy = (Day_Fat_kcal/Day_FoodEnergy)*100,
        Day_SatFat_PropFoodEnergy = (Day_SatFat_Kcal/Day_FoodEnergy)*100,
        Day_TransFat_PropFoodEnergy = (Day_TransFat_Kcal/Day_FoodEnergy)*100) %>%
      relocate(Day_Carbs_PropFoodEnergy, .after = Day_Carbs_kcal) %>%
      relocate(Day_TotalSugars_PropFoodEnergy, .after = Day_TotalSugars_kcal) %>%
      relocate(Day_Fat_PropFoodEnergy, .after = Day_Fat_kcal) %>%
      relocate(Day_SatFat_PropFoodEnergy, .after = Day_SatFat_Kcal) %>%
      relocate(Day_TransFat_PropFoodEnergy, .after = Day_TransFat_Kcal)
```



##Energy Density
```{r}
df.intake24_recall <- df.intake24_recall %>%
      mutate(Day_EnergyDensity = (Day_FoodEnergyMilk/Day_FoodGramsMilk)*100) %>%
      relocate(Day_EnergyDensity, .after = Day_FoodGramsMilk)
```

##High and low energy recalls

```{r}
#create a subset of recalls where kcals are less than 400
low_kcal <- df.intake24_recall %>%
  filter(Day_Energykcal <= 400)

#create a subset for recalls with high kcal
high_kcal <- df.intake24_recall %>%
  filter(Day_Energykcal >= 4000)

## Look at all items in each recall that has low or high energy intake

#join summed variables to intake24, keeping only those IDs and RecallNo that are in both datasets
high_kcal_items <- inner_join(df.intake24_item, high_kcal, by = c("UserID","HouseholdID", "RecallNo", "Sex","Ethnicity","Age", "CalcAge","age_cat","simd_quintile", "NumberOfRecalls"))


low_kcal_items <- inner_join(df.intake24_item, low_kcal, by = c("UserID","HouseholdID", "RecallNo", "Sex","Ethnicity","Age", "CalcAge","age_cat","simd_quintile", "NumberOfRecalls"))


```
```{r include=FALSE}
#look at all low kcal recalls to help with determining decisions

low_ids <- low_kcal %>%
  select(UserID)

Low_intake_all_recalls <- inner_join(df.intake24_item, low_ids, by = "UserID", relationship = "many-to-many")
Low_intake_all_recalls_1 <- left_join(Low_intake_all_recalls, df.intake24_recall, by = c("UserID","HouseholdID", "RecallNo", "Sex","Ethnicity","Age", "CalcAge","age_cat","simd_quintile", "NumberOfRecalls"))

n_distinct(low_ids$UserID)
n_distinct(Low_intake_all_recalls_1$UserID)
```

```{r eval=FALSE, include=FALSE}
#export high and low energy intakes
write.xlsx(high_kcal_items, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/intake24_high_kcal_all_280824.xlsx")
write.xlsx(low_kcal_items, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/intake24_low_kcal_all_280824.xlsx")

write.xlsx(Low_intake_all_recalls_1, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/intake24_low_kcal_ids_all_recalls_280824.xlsx")

rm(low_kcal,low_kcal_items,high_kcal, high_kcal_items, low_ids,Low_intake_all_recalls_1)

check <- df.intake24_item %>%
  filter(UserID == "10006095")
```

#Participant Level Dataset
```{r}
# Participant level
  df.intake24_participant <- df.intake24_recall %>% 
      group_by(UserID) %>%
      summarise(
        HouseholdID = first(HouseholdID),
        Sex = first(Sex),
        Ethnicity = first(Ethnicity),
        Age = first(Age),
        CalcAge = first(CalcAge), 
        age_cat = first(age_cat),
        simd_quintile = first(simd_quintile),
        NumberOfRecalls = first(NumberOfRecalls),
        Avg_Energykcal = mean(Day_Energykcal),
        Avg_FoodEnergy = mean(Day_FoodEnergy),
        Avg_FoodEnergyMilk = mean(Day_FoodEnergyMilk),
        Avg_FoodGrams = mean(Day_FoodGrams),
        Avg_FoodGramsMilk = mean(Day_FoodGramsMilk),
        Avg_EnergyDensity = mean(Day_EnergyDensity),
        Avg_Carbohydrate = mean(Day_Carbohydrate),
        Avg_Carbs_kcal = mean(Day_Carbs_kcal),
        Avg_Carbs_PropFoodEnergy = mean(Day_Carbs_PropFoodEnergy),
        Avg_TotalSugars = mean(Day_TotalSugars),
        Avg_TotalSugars_kcal = mean(Day_TotalSugars_kcal),
        Avg_TotalSugars_PropFoodEnergy = mean(Day_TotalSugars_PropFoodEnergy),
        Avg_TotalFatg = mean(Day_TotalFatg),
        Avg_Fat_kcal = mean(Day_Fat_kcal),
        Avg_Fat_PropFoodEnergy = mean(Day_Fat_PropFoodEnergy),
        Avg_SatFatg = mean(Day_SatFatg),
        Avg_SatFat_Kcal = mean(Day_SatFat_Kcal),
        Avg_SatFat_PropFoodEnergy = mean(Day_SatFat_PropFoodEnergy),
        Avg_TransFatg = mean(Day_TransFatg),
        Avg_TransFat_Kcal = mean(Day_TransFat_Kcal),
        Avg_TransFat_PropFoodEnergy = mean(Day_TransFat_PropFoodEnergy),
        Avg_Protein = mean(Day_Protein),
        Avg_AOACFibre = mean(Day_AOACFibre),
        Avg_VitaminA = mean(Day_VitaminA),
        Avg_Riboflavin = mean(Day_Riboflavin),
        Avg_Folate = mean(Day_Folate),
        Avg_VitaminD = mean(Day_VitaminD),
        Avg_VitaminB12 = mean(Day_VitaminB12),
        Avg_VitaminC = mean(Day_VitaminC),
        Avg_Iron = mean(Day_Iron),
        Avg_Calcium = mean(Day_Calcium),
        Avg_Sodium = mean(Day_Sodium),
        Avg_Salt = mean(Day_Salt),
        Avg_Iodine = mean(Day_Iodine),
        Avg_Magnesium = mean(Day_Magnesium),
        Avg_Potassium = mean(Day_Potassium),
        Avg_Selenium = mean(Day_Selenium),
        Avg_Zinc = mean(Day_Zinc)) %>%
      ungroup() 
```

```{r eval=FALSE, include=FALSE}
# Check no duplicates
     n_distinct(df.intake24_participant$UserID)
```

#Re-code discretionary foods
```{r}
savoury_biscuits_list <- c("7649","251","252","3973","7650","8330","258","256","255","273","3267","266","267","3236","279","10062","11242","274","7652")
    
    lollies <- c("7762", "2262")
    
    pizza <- c("11511", "10029","10028","10030","10032","11514","11508","10026","11516","11512","11509","11510","11512", "10031", "11511","2743","10033","10034") #11512 has 2 different descriptions, same code
    
    ready_meal <- c("8049","8011","9245","3187","1347","9386","9244","8666","10298","4283","3730","10755","6393","9328","1356","8588","5320","2734","9300","5321","7094","9318","9270","1116","5627","8038","1352")
    
```

```{r eval=FALSE, include=FALSE}
#Check re-coding
biscuits_sav <- df.intake24_item %>%
     filter(NutrientTableCode == c(savoury_biscuits_list))

```

#Re-code Main Food Groups into summary categories for reporting
We're reporting intakes of the following food groups:

Red meat
Red processed meat
Red meat and red processed meat combined
Oily fish
Fruit
Vegetables
Fruit and vegetables combined
Fruit juice
Sugar-sweetened beverages
Sugar confectionery
Chocolate confectionery
Sweet biscuits
Savoury biscuits
Cakes, pastries and fruit pies
Crisps and savoury snacks
Pizzas and ready meals

1) Below estimates are from food groups (i.e. don't include disaggregated estimates). This is the only way we can look at nutritional contributions.

2) Do FSS want to include pork within red meat definitions? The below code captures pork, but I know there's been some discussion on this back and forth.
             
Create binary variable for red meat
```{r}
#create binary variable and categorise all red and red processed meat based on main food group codes
df.intake24_item <- df.intake24_item %>%
      mutate(RedMeat = case_when(
        MainFoodGroupCode %in% c(23, 24, 25, 28, 22, 29, 30, 31, 32) ~ 1, 
        TRUE ~ 0
        ))
                                               
#check 'other meat' category to determine what needs to be re-coded
check <- df.intake24_item %>%
  filter(MainFoodGroupCode == "32")
                                               
#remove any meat that is not red meat from binary variable
df.intake24_item <- df.intake24_item %>%
  mutate(RedMeat = case_when(
    MainFoodGroupCode == "32" &
      (str_detect(Description_English, regex("chicken", ignore_case = TRUE))) ~ 0,
    TRUE ~ RedMeat
    ))
                                             
                                               
check <- df.intake24_item %>%
  filter(MainFoodGroupCode == 35)
```

Create reporting food groups
```{r}
# Create reporting food groups 
df.intake24_item <- df.intake24_item %>% 
 mutate(ReportingFoodGroupCode = case_when (
   #Red meat
   MainFoodGroupCode %in% c(23, 24, 25, 28) & RedMeat == 1 ~ 1,
   #Red processed meat
   MainFoodGroupCode %in% c(22, 29, 30, 31, 32) & RedMeat == 1 ~ 2,
   #Oily fish
   MainFoodGroupCode == 35 ~ 3,
   #Fruit
   MainFoodGroupCode == 40 ~ 4,
   # Vegetables
   MainFoodGroupCode == 36 ~ 5,
   # Fruit juice - sometimes you need to specify the subfoodgroup instead of main food group - this captures only fruit juice and not smoothies
   SubFoodGroupCode == "45R" ~ 6,
   # Sugar-sweetened beverages
   MainFoodGroupCode == 57 ~ 7,
   # Sugar confectionery
   MainFoodGroupCode == 43 & !NutrientTableCode %in% c(lollies) ~ 8,
   # Chocolate confectionery
   MainFoodGroupCode == 44 ~ 9,
   # Sweet biscuits
   MainFoodGroupCode == 7 & !NutrientTableCode %in% c(savoury_biscuits_list) ~ 10,
  # Savoury biscuits
  MainFoodGroupCode == 7 & NutrientTableCode %in% c(savoury_biscuits_list) ~ 11,
   # Cakes, pastries and fruit pies
   MainFoodGroupCode == 8 ~ 12,
   # Crisps and savoury snacks
   MainFoodGroupCode == 42 ~ 13,
   #Pizzas and ready meals
   NutrientTableCode %in% c(pizza, ready_meal) ~ 14,
   #Ice creams
   MainFoodGroupCode == 53 | NutrientTableCode %in% c(lollies) ~ 15,
      TRUE ~ NA))
```

Create descriptions
```{r}
# Add description variable
df.intake24_item <- df.intake24_item %>%
  mutate(ReportingFoodGroupDesc = case_when(
    ReportingFoodGroupCode == 1 ~ "Red meat",
    ReportingFoodGroupCode == 2 ~ "Red processed meat",
    ReportingFoodGroupCode == 3 ~ "Oily fish",
    ReportingFoodGroupCode == 4 ~ "Fruit",
    ReportingFoodGroupCode == 5 ~ "Vegetables",
    ReportingFoodGroupCode == 6 ~ "Fruit juice",
    ReportingFoodGroupCode == 7 ~ "Sugar-sweetened beverages",
    ReportingFoodGroupCode == 8 ~ "Sugar confectionery",
    ReportingFoodGroupCode == 9 ~ "Chocolate confectionery",
    ReportingFoodGroupCode == 10 ~ "Sweet biscuits",
    ReportingFoodGroupCode == 11 ~ "Savoury biscuits",
    ReportingFoodGroupCode == 12 ~ "Cakes, pastries and fruit pies",
    ReportingFoodGroupCode == 13 ~ "Crisps and savoury snacks",
    ReportingFoodGroupCode == 14 ~ "Pizzas and ready meals",
    ReportingFoodGroupCode == 15 ~ "Ice cream and lollies",
       TRUE ~ "Other"))
```


```{r eval=FALSE, include=FALSE}
#Check food groups for foods of interest that may not be reported in the above
df.intake24_item %>%
  count(MainFoodGroupDesc, MainFoodGroupCode, SubFoodGroupCode, ReportingFoodGroupDesc, ReportingFoodGroupCode) %>%
View()

check <- df.intake24_item %>%
  filter(SubFoodGroupCode == "61R")
```


#Food Groups: Calculate Mean Daily Intakes (g) of Reporting Food Groups

##Daily Intakes
```{r}
#Daily intakes (g)
df.intake24_foodgroup_recall <- df.intake24_item %>%
  group_by(UserID, RecallNo) %>%
  summarise(
    NumberOfRecalls = first(NumberOfRecalls),
    Day_redmeat = sum(TotalGrams[ReportingFoodGroupCode == 1 ], na.rm = TRUE),
    Day_processedmeat = sum(TotalGrams[ReportingFoodGroupCode == 2], na.rm = TRUE),
    Day_redprocessedmeat = sum(TotalGrams[ReportingFoodGroupCode %in% c(1, 2)], na.rm = TRUE),
    Day_oilyfish = sum(TotalGrams[ReportingFoodGroupCode == 3], na.rm = TRUE),
    Day_fruit = sum(TotalGrams[ReportingFoodGroupCode == 4], na.rm = TRUE),
    Day_veg = sum(TotalGrams[ReportingFoodGroupCode == 5], na.rm = TRUE),
    Day_fruitveg = sum(TotalGrams[ReportingFoodGroupCode %in% c(4, 5)], na.rm = TRUE),
    Day_fruitjuice = sum(TotalGrams[ReportingFoodGroupCode == 6], na.rm = TRUE),
    Day_ssb = sum(TotalGrams[ReportingFoodGroupCode == 7], na.rm = TRUE),
    Day_sugarconfec = sum(TotalGrams[ReportingFoodGroupCode == 8], na.rm = TRUE),
    Day_chocolateconfec = sum(TotalGrams[ReportingFoodGroupCode == 9], na.rm = TRUE),
    Day_sweetbiscuits = sum(TotalGrams[ReportingFoodGroupCode == 10], na.rm = TRUE),
    Day_savourybiscuits = sum(TotalGrams[ReportingFoodGroupCode == 11], na.rm = TRUE),
    Day_cakespies = sum(TotalGrams[ReportingFoodGroupCode == 12], na.rm = TRUE),
    Day_savourysnacks = sum(TotalGrams[ReportingFoodGroupCode == 13], na.rm = TRUE),
    Day_pizzareadymeals = sum(TotalGrams[ReportingFoodGroupCode == 14], na.rm = TRUE),
    Day_icecream = sum(TotalGrams[ReportingFoodGroupCode == 15], na.rm = TRUE))%>%
  ungroup()

# Join with recall level intake24 dataset
df.intake24_recall <- left_join(df.intake24_recall, df.intake24_foodgroup_recall, by=c("UserID", "RecallNo", "NumberOfRecalls"))

```

##Mean Daily Intakes
```{r}
# Mean daily intakes (g)
df.intake24_foodgroup_participant <- df.intake24_foodgroup_recall %>%
  group_by(UserID) %>%
  summarise(
    NumberOfRecalls = first(NumberOfRecalls),
    Avg_redmeat = mean(Day_redmeat),
    Avg_processedmeat = mean(Day_processedmeat),
    Avg_redprocessedmeat = mean(Day_redprocessedmeat),
    Avg_oilyfish = mean(Day_oilyfish),
    Avg_fruit = mean(Day_fruit),
    Avg_veg = mean(Day_veg),
    Avg_fruitveg = mean(Day_fruitveg),
    Avg_fruitjuice = mean(Day_fruitjuice),
    Avg_ssb = mean(Day_ssb),
    Avg_sugarconfec = mean(Day_sugarconfec),
    Avg_chocolateconfec = mean(Day_chocolateconfec),
    Avg_sweetbiscuits = mean(Day_sweetbiscuits),
    Avg_savourybiscuits = mean(Day_savourybiscuits),
    Avg_cakespies = mean(Day_cakespies),
    Avg_savourysnacks = mean(Day_savourysnacks),
    Avg_pizzareadymeals = mean(Day_pizzareadymeals),
    Avg_icecream = mean(Day_icecream)) %>%
  ungroup()

# Join with participant level intake24 dataset
df.intake24_participant <- left_join(df.intake24_participant, df.intake24_foodgroup_participant, by=c("UserID", "NumberOfRecalls"))

rm(df.intake24_foodgroup_recall, df.intake24_foodgroup_participant)
```

#Food groups - contributions to energy and free sugar intake
```{r}
# Calculate daily intakes of energy and free sugars from food groups
df.intake24_recall_fg <- df.intake24_item %>%
  group_by(UserID, RecallNo, ReportingFoodGroupCode) %>% 
  summarise(
    NumberOfRecalls = first(NumberOfRecalls),
    Day_Energy_fg=sum(Energykcal),
    Day_FreeSugars_fg=sum(TOTALFS)) #sugars
```

Create grids
```{r}
# Create a grid with all possible food category and recall number combinations for each participant
# Need to do this separately for different recall numbers

# 1 recall
df.onerecall <- df.intake24_recall %>%
  filter(NumberOfRecalls == 1)

foodgrid_onerecall <- expand.grid( #create a grid of each combination of the below:
  UserID = unique(df.onerecall$UserID), #take each unique UserID
  RecallNo = unique(df.onerecall$RecallNo), #take each unique RecallNo
  ReportingFoodGroupCode = factor(1:15)) #create a column of with 1-12 for reporting food groups

# 2 recalls
df.tworecalls <- df.intake24_recall %>%
  filter(NumberOfRecalls == 2)

foodgrid_tworecalls <- expand.grid(
  UserID = unique(df.tworecalls$UserID),
  RecallNo = unique(df.tworecalls$RecallNo),
  ReportingFoodGroupCode = factor(1:15))

# 3 recalls
df.threerecalls <- df.intake24_recall %>%
  filter(NumberOfRecalls == 3)

foodgrid_threerecalls <- expand.grid(
  UserID = unique(df.threerecalls$UserID),
  RecallNo = unique(df.threerecalls$RecallNo),
  ReportingFoodGroupCode = factor(1:15))

#4 recalls 
df.fourrecalls <- df.intake24_recall %>%
  filter(NumberOfRecalls == 4)

foodgrid_fourrecalls <- expand.grid(
  UserID = unique(df.fourrecalls$UserID),
  RecallNo = unique(df.threerecalls$RecallNo),
  ReportingFoodGroupCode = factor(1:15))
```

Combine grids
```{r}
# Combine expanded grids
foodgroup_grid <- bind_rows(foodgrid_onerecall, foodgrid_tworecalls, foodgrid_threerecalls) %>%
  arrange(UserID, RecallNo) %>%
  mutate(ReportingFoodGroupCode = as.numeric(ReportingFoodGroupCode))

# Join daily intakes with expanded grids
df.intake24_recall_fg <- left_join(foodgroup_grid, df.intake24_recall_fg, by = c("UserID", "RecallNo", "ReportingFoodGroupCode")) %>%
  relocate(NumberOfRecalls, .after=UserID)

# Change NA values to 0 
df.intake24_recall_fg <- df.intake24_recall_fg %>%
  mutate_all(~ifelse(is.na(.), 0, .))

# Remove datasets no longer needed
rm(foodgrid_onerecall, foodgrid_tworecalls, foodgrid_threerecalls, foodgroup_grid)

```

Calculate mean daily intakes of energy and free sugars from food groups
```{r}
# Participant level dataset
df.intake24_participant_fg <- df.intake24_recall_fg %>%
  group_by(UserID, ReportingFoodGroupCode) %>% 
  mutate(
    Avg_Energy_fg = ifelse(NumberOfRecalls != 0,  sum(Day_Energy_fg)/NumberOfRecalls, NA),
    Avg_FreeSugars_fg = ifelse(NumberOfRecalls != 0,  sum(Day_FreeSugars_fg)/NumberOfRecalls, NA))%>%
  ungroup()

# Change NA values to 0 
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  mutate_all(~ifelse(is.na(.), 0, .))

# Fill in values across food groups in all recalls
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  group_by(UserID, ReportingFoodGroupCode) %>%
  mutate(across(starts_with("Avg_"), ~max(., na.rm = TRUE))) %>%
  ungroup()

# Drop day level variables (as participant level dataset)
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  select(-starts_with("Day_"))

#Keep one line per food group per participant
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  distinct(UserID, ReportingFoodGroupCode, .keep_all = TRUE)

```

Calculate energy and free sugar contributions from food groups
```{r}
# Pull out mean daily intakes of energy and free sugars
NutrientIntakes <- subset(df.intake24_participant, select=c(UserID, Avg_Energykcal, Avg_TotalSugars))

# Join with mean daily intakes of energy and free sugars from food groups 
df.intake24_participant_fg <- left_join(NutrientIntakes, df.intake24_participant_fg, by=c("UserID"))

#Calculate nutritional contributions from food categories
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  group_by(UserID, ReportingFoodGroupCode) %>%
  mutate(
    Prop_Energy_fg=(Avg_Energy_fg/Avg_Energykcal)*100,
    Prop_FreeSugars_fg=(Avg_FreeSugars_fg/Avg_TotalSugars)*100,) %>%
  ungroup() %>%
  relocate(ReportingFoodGroupCode, .after=UserID) %>% 
  select(-RecallNo, -NumberOfRecalls, -Avg_Energykcal, -Avg_TotalSugars) %>%
  mutate_at(vars(starts_with("Prop_")), ~round(., 2))

# Change NA values to 0 
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  mutate_all(~ifelse(is.na(.), 0, .))
```

Add in Reporting descriptions
```{r}
#add in description of reporting food codes
df.intake24_participant_fg <- df.intake24_participant_fg %>%
  mutate(ReportingFoodGroupDesc = case_when(
    ReportingFoodGroupCode == 1 ~ "Red meat",
    ReportingFoodGroupCode == 2 ~ "Red processed meat",
    ReportingFoodGroupCode == 3 ~ "Oily fish",
    ReportingFoodGroupCode == 4 ~ "Fruit",
    ReportingFoodGroupCode == 5 ~ "Vegetables",
    ReportingFoodGroupCode == 6 ~ "Fruit juice",
    ReportingFoodGroupCode == 7 ~ "Sugar-sweetened beverages",
    ReportingFoodGroupCode == 8 ~ "Sugar confectionery",
    ReportingFoodGroupCode == 9 ~ "Chocolate confectionery",
    ReportingFoodGroupCode == 10 ~ "Sweet biscuits",
    ReportingFoodGroupCode == 11 ~ "Savoury biscuits",
    ReportingFoodGroupCode == 12 ~ "Cakes, pastries and fruit pies",
    ReportingFoodGroupCode == 13 ~ "Crisps and savoury snacks",
    ReportingFoodGroupCode == 14 ~ "Pizzas and ready meals",
    ReportingFoodGroupCode == 15 ~ "Ice cream and lollies",
    TRUE ~ NA_character_))

```




#Write files for analysis
```{r eval=FALSE, include=FALSE}
write.csv(df.intake24_participant_fg, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output_data_analysis/intake24_FS_Energy_28_08_24.csv")
write.csv(df.intake24_participant, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output_data_analysis/intake24_participant_28_08_24.csv")
write.csv(df.intake24_recall, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output_data_analysis/intake24_recall_28_08_24.csv")

write.csv(df.intake24_item, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output_data_analysis/intake24_item_28_08_24.csv")



```


