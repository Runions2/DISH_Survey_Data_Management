---
title: "DISH Cleaning"
output: html_notebook
---

This notebook cleans the online survey and intake24 data. 

# Prepare R Environment
```{r message=FALSE, warning=FALSE, include=FALSE}
#clear R environment
rm(list = ls())

#fixing error on rJava when reading in excel sheet - override memory limit, this may not work for every instance or machine - must be run before loading libraries
options(java.parameters = "- Xmx1024m")

#load required packages
library(dplyr)
library(tidyr)
library(rio)
library(ggplot2)
library(lubridate)
library(stringr)
library(readxl)
#library(XLConnect)
library(flextable)
library(gtsummary)
library(writexl)
library(tibble)
library(readxl)
library(janitor)
library(openxlsx)
library(forcats)

```

# Read in data
```{r message=FALSE, warning=FALSE}
#import sheets from excel file
df.survey_full <- read_excel( "/Users/ricki/Desktop/DISH_data_cleaning/Data/Initial_survey_26.08.24.xlsx")
df.intake24_full <- read_excel( "/Users/ricki/Desktop/DISH_data_cleaning/Data/intake24_26.08.24.xlsx")

#df.survey_full <- read_excel( "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Data/survey_26.08.24.xlsx")
#df.intake24_full <- read_excel( "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Data/intake24_26.08.24.xlsx")
```

## Clean names
```{r message=FALSE, warning=FALSE}
#set all column names to lower case and replace spaces and special characters with underscores
df.survey <- clean_names(df.survey_full)
df.intake24_item <- clean_names(df.intake24_full)

# remove dataframes that are no longer needed
rm(df.survey_full, df.intake24_full)
```

## Rename variables - survey
```{r}
# rename simd column to match previous data update files - needed for data update on 14.03.24
df.survey <- df.survey %>%
  rename(simd_quintile = simd)

# select only the variables of interest
df.survey <- df.survey %>%
  select(household_id, simd_quintile, la_code, id_case, id_name, id_date, id_start, id_end_date, id_end, id_time, q1, q5, q6, q7, q7a, q8, q9,q10, q11, q12, q13, q14, q15, q16, q17, q18, q19, q20, q21, q24, q33,q34,q37, q38, q39, q40,q41, q42, q43, q43a, q43b, q43c, q43d, q43e, q43f, q44, q45, q46, q47, q48, q49, q49a, q49b, q49c, q49d, q50, q51)

# rename variable columns
df.survey <- df.survey %>%
  rename(HouseholdID = household_id, # new name first then old name that we are changing
         simd_quintile = simd_quintile,  
         psu = la_code,
         SurveyID = id_case ,
         UserID = id_name, 
         StartDate = id_date, 
         StartTime = id_start, 
         FinishDate = id_end_date, 
         FinishTime = id_end, 
         SurveyDuration = id_time, 
         NumberOfChildren = q1, 
         DOB = q5, 
         Sex = q6, 
         Ethnicity = q7, 
         EthnicityOther = q7a, 
         Education = q8, 
         FoodParcels = q9,
         HhldAdults = q10, 
         HhldChildren = q11, 
         HHFOOD1 = q12, 
         HHFOOD2 = q13, 
         HHFOOD3 = q14, 
         HHFOOD4 = q15, 
         AFreqWhiteMeat = q16, 
         AFreqRRPM = q17, 
         AFreqWhiteFish = q18, 
         AFreqOilyFish = q19, 
         AFreqOtherFish = q20, 
         AFreqToddlerMilk = q21, 
         ChildCompletedFoodDiary = q24, 
         FurtherSurveyContact = q33,
         FurtherSurveyContact2 = q34,
         YPFreqWhiteMeat = q37, 
         YPFreqRRPM = q38, 
         YPFreqWhiteFish = q39, 
         YPFreqOilyFish = q40,
         YPFreqOtherFish = q41, 
         YPFreqOffSchlGrounds = q42, 
         AgreeOSG1 = q43, 
         AgreeOSG2 = q43a, 
         AgreeOSG3 = q43b, 
         AgreeOSG4 = q43c, 
         AgreeOSG5 = q43d, 
         AgreeOSG6 = q43e, 
         AgreeOSG7 = q43f, 
         AgreeOSG_Other = q44, 
         UseFoodApps = q45, 
         EnergyDrinksFirstOrderAge = q46, 
         FreqOSG = q47, 
         FreqEnergyDrinks = q48, 
         ImportanceED1 = q49, 
         ImportanceED2 = q49a, 
         ImportanceED3 = q49b, 
         ImportanceED4 = q49c,
         ImportanceED5 = q49d, 
         ImportanceED_Other = q50, 
         SurveyConsent = q51)

# convert to factor
df.survey <- df.survey %>%
  mutate(across(c(psu, Sex),as.factor))

df.survey <- df.survey %>%
  mutate(psu=fct_recode(psu,"Aberdeen City"="100","Aberdeenshire"="110","Angus"="120","Argyll and Bute"="130",
                        "City of Edinburgh"="230","Clackmannanshire"="150","Dumfries and Galloway"="170",
                        "Dundee City"="180","East Ayrshire"="190","East Dunbartonshire"="200",
                        "East Lothian"="210","East Renfrewshire"="220","Falkirk"="240","Fife"="250",
                        "Glasgow City"="260","Highland"="270","Inverclyde"="280","Midlothian"="290",
                        "Moray"="300","Na h-Eileanan Siar"="235","North Ayrshire"="310",
                        "North Lanarkshire"="320","Orkney Islands"="330","Perth and Kinross"="340",
                        "Renfrewshire"="350","Scottish Borders"="355","Shetland Islands"="360",
                        "South Ayrshire"="370","South Lanarkshire"="380","Stirling"="390",
                        "West Dunbartonshire"="395","West Lothian"="400"))
```

## Rename variables - intake24
```{r}
# **TO UPDATE** select only the variables of interest
df.intake24_item <- df.intake24_item %>%
  select(-proxy, -proxy_issues, -serving_image, -leftovers_image, -food_group_local, -brand, -meal_index, -meal_id, -food_index, -nutrient_table_name, -reasonable_amount, -water, -total_nitrogen, -nitrogen_conversion_factor, -non_milk_extrinsic_sugars, -intrinsic_and_milk_sugars, -starch, -englyst_fibre, -glucose, -fructose, -maltose, -lactose, -sucrose, -total_sugars, -other_sugars_uk, -fs_table_sugar, -fs_other_added_sugar, -fs_honey, -fs_fruit_juice, -fs_dried_fruit, -fs_fruit_puree, -fs_stewed_fruit, -fs_vegetable_puree, -cis_mon_fa, -cis_n3_fa, -cis_n6_fa, -cholesterol, -retinol, -total_carotene, -alpha_carotene, -beta_carotene, -beta_cryptoxanthin, -tryptophan_60, -niacin_equivalent, -copper, -chloride, -manganese, -thiamin, -vitamin_e, -niacin, -vitamin_b6, -pantothenic_acid, -biotin, -phosphorus) #add back all nutrients before data archival

# rename variable columns
df.intake24_item <- df.intake24_item %>%
  rename(SurveyID = survey_id , # new name first then old name that we are changing
         UserID = user_id, 
         Device = device_information_user_agent,
         StartTime = start_time, 
         FinishTime = submission_time, 
         SurveyDuration = time_to_complete, 
         FoodAmount = food_amount,
         FoodAmountReason = reason_for_unusual_food_amount,
         MealName = meal_name,
         MealTime = meal_time,
         FoodSource = food_source,
         SearchTerm = search_term,
         FoodID = food_id,
         Intake24FoodCode= intake24_food_code,
         Description_English = description_en,
         Description_Local = description_local,
         NutrientTableCode= nutrient_table_code,
         FoodGroupCode = food_group_code,
         FoodGroupEnglish= food_group_en,
         ReadyMeal= ready_meal,
         AsServedWeightFactor= as_served_weight_factor,
         ServingSizeGrams = serving_size_g_ml,
         LeftoversGrams = leftovers_g_ml,
         TotalGrams = portion_size_g_ml,
         MissingFoodID = missing_food_id, 
         MissingFoodDescription = missing_food_description, 
         MissingFoodPortionSize = missing_food_portion_size,  
         MissingFoodLeftovers = missing_food_leftovers,
         SubFoodGroupCode = sub_group_code,
         Energykcal = energy_kcal,
         Energykj= energy_k_j,
         Carbohydrateg = carbohydrate,
         Proteing = protein,
         Fatg = fat,
         Alcoholg = alcohol,
         Saturatedfattyacidsg = satd_fa,
         Transfattyacidsg = trans_fa,
         Freesugarsg = total_fs,
         AOACg = aoac,
         VitaminAug = vitamin_a,
         Riboflavinmg = riboflavin,
         Folateug = folate,
         VitaminDug = vitamin_d,
         VitaminB12ug = vitamin_b12,
         VitaminCmg = vitamin_c,
         Ironmg = iron,
         haemironmg = haem_iron,
         Nonhaemironmg = non_haem_iron,
         Calciummg = calcium,
         Iodineug = iodine,
         Sodiummg = sodium,
         Magnesiummg = magnesium,
         Potassiummg = potassium,
         Seleniumug = selenium,
         Zincmg = zinc,
         Fruitg = fruit,
         DriedFruitg = dried_fruit,
         FruitJuiceg = fruit_juice,
         SmoothieFruitg = smoothie_fruit,
         Tomatoesg = tomatoes,
         TomatoPureeg = tomato_puree,
         Brassicaceaeg = brassicaceae,
         YellowRedGreeng = yellow_red_green,
         Beansg = beans,
         Nutsg = nuts,
         OtherVegg = other_vegetables,
         Beefg = beef,
         Lambg = lamb,
         Porkg = pork,
         ProcessedRedMeatg = processed_red_meat,
         OtherRedMeatg = other_red_meat,
         Burgersg = burgers,
         Sausagesg = sausages,
         Offalg = offal,
         Poultryg = poultry,
         ProcessedPoultryg = processed_poultry,
         GameBirdsg = game_birds,
         WhiteFishg = white_fish,
         OilyFishg = oily_fish,
         CannedTunag = canned_tuna,
         Shellfishg = shellfish,
         CottageCheeseg= cottage_cheese,
         CheddarCheeseg = cheddar_cheese,
         OtherCheeseg = other_cheese
  ) 
```

# Clean Data
## Check duplicates
```{r}
# check for duplicates
n_distinct(df.survey$UserID)
n_distinct(df.intake24_item$UserID)
```
## Remove ineligibles
```{r}
# calculate the age of the participant. This calculates the interval between two columns, the birthdate and the survey completion date and then divides by a function setting the years to 1
df.survey$CalcAge <- interval(df.survey$DOB, df.survey$StartDate) / years(1)
df.survey$Age <- trunc(df.survey$CalcAge)

# relocate column in data frame
df.survey <- df.survey %>%
  relocate(c(CalcAge, Age), .after = DOB)

# check those removed for being outside the age range
age_removed <- df.survey[which(df.survey$CalcAge<2 | df.survey$CalcAge>16),]

# keep only the participants that are between 2-15 years old
df.survey <- df.survey[which(df.survey$CalcAge>=2 & df.survey$CalcAge<16),]

# remove age-ineligible recalls
df.intake24_item <- df.intake24_item %>%
  filter(!UserID %in% c(10007139, 10006439, 10004147))

# remove participant with incomplete data
df.intake24_item <- df.intake24_item %>%
  filter(!UserID %in% c(10008296))

df.survey <- df.survey %>%
  filter(!UserID %in% c(10008296))

# remove surveys that have no recalls
participant_ids <- df.intake24_item %>%
  select(UserID) %>%
  distinct()

df.survey <- df.survey %>%
  semi_join(participant_ids, by = "UserID")

rm(age_removed, participant_ids)
```

## Re-code NA food insecurity responses
Further food insecurity questions were only asked if they responded 'Yes' to the first questions, we therefore presume they are not food-insecure for all remaining questions if they respond 'No' to the initial question.
```{r}
df.survey <- df.survey %>%
  mutate(HHFOOD2 = case_when(
    is.na(HHFOOD2) ~ "No",
    TRUE ~ HHFOOD2
  ))

df.survey <- df.survey %>%
  mutate(HHFOOD3 = case_when(
    is.na(HHFOOD3) ~ "No",
    TRUE ~ HHFOOD3
  ))

df.survey <- df.survey %>%
  mutate(HHFOOD4 = case_when(
    is.na(HHFOOD4) ~ "No",
    TRUE ~ HHFOOD4
  ))
```

## Re-code Not sure food parcels responses
Assume those who don't know (n=44) do not receive food parcels.
```{r}
df.survey <- df.survey %>%
  mutate(FoodParcels = case_when(
    FoodParcels =="Not sure" ~ "No",
    TRUE ~ FoodParcels
  ))
```

# Categorise 'other' text
For 'other', categorise into existing categories or create new categories if reported by >5 participants.
```{r}
# ethnicity
subset_Ethnicity_Other <- df.survey %>% 
  filter(!is.na(EthnicityOther))

df.survey$Ethnicity <- factor(df.survey$Ethnicity, levels = c("White", "Asian or Asian British", "Mixed or multiple ethnic groups", "Black, Black British, Caribbean or African", "Other", "Prefer not to say"))

df.survey <- df.survey %>%
  mutate(Ethnicity = case_when(
    EthnicityOther=="Polish and Spanish" ~ "Mixed or multiple ethnic groups",
    EthnicityOther=="Chinese" ~ "Asian or Asian British",
    EthnicityOther=="White scottish" ~ "White",
    EthnicityOther=="Half Scottish half Tenerifian" ~ "Mixed or multiple ethnic groups",
    TRUE ~ Ethnicity
  ))

# create subset df of 'Other' text to recategorise 
subset_AgreeOSG_Other <- df.survey %>% 
  filter(!is.na(AgreeOSG_Other)) %>% #if there is any text in Q50, create a df with those participants 
  select(UserID, Age, Sex, YPFreqOffSchlGrounds, AgreeOSG1, AgreeOSG2, AgreeOSG3, AgreeOSG4, AgreeOSG5, AgreeOSG6, AgreeOSG7, AgreeOSG_Other)

subset_ImportanceED_Other <- df.survey %>% 
  filter(!is.na(ImportanceED_Other)) %>% #if there is any text in Q50, create a df with those participants 
  select(UserID, Age, Sex, FreqOSG, FreqEnergyDrinks, ImportanceED1, ImportanceED2, ImportanceED3, ImportanceED4, ImportanceED5, ImportanceED_Other)

# export for review
#write.xlsx(subset_AgreeOSG_Other, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/Other_response_OSG_280824.xlsx")
#write.xlsx(subset_ImportanceED_Other, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/Other_response_ED_280824.xlsx")
#write.xlsx(subset_AgreeOSG_Other, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Other_response_OSG_280824.xlsx")
#write.xlsx(subset_ImportanceED_Other, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Other_response_ED_280824.xlsx")

# remove dataframes that are no longer needed
rm(subset_Ethnicity_Other, subset_AgreeOSG_Other, subset_ImportanceED_Other)
```

# Create New Variables
## Age groups
```{r}
# report age group
df.survey <- df.survey %>%
  mutate(
    age_cat = case_when(
      CalcAge >= 2 & CalcAge < 5 ~ "2-4y",
      CalcAge >= 5 & CalcAge < 11 ~ "5-10y", 
      CalcAge >= 11 & CalcAge < 16 ~ "11-15y",
      TRUE ~ NA)) %>%
  relocate(age_cat, .after = Age)

# DRVs age group
df.survey <- df.survey %>%
  mutate(
    age_cat_drv = case_when(
      CalcAge >= 2 & CalcAge < 4 ~ "2-3y",
      CalcAge >= 4 & CalcAge < 7 ~ "4-6y",
      CalcAge >= 7 & CalcAge < 11 ~ "7-10y", 
      CalcAge >= 11 & CalcAge < 15 ~ "11-14y",
      CalcAge >= 15 ~ "15y",
      TRUE ~ NA)) %>%
  relocate(age_cat_drv, .after = age_cat)
```

## Age and sex groups
```{r}
# report age group
df.survey <- df.survey %>%
  mutate(
    age_sex_cat = case_when(
      Sex == "Male" & CalcAge >= 2 & CalcAge < 5 ~ "Male, 2-4y",
      Sex == "Male" & CalcAge >= 5 & CalcAge < 11 ~ "Male, 5-10y", 
      Sex == "Male" & CalcAge >= 11 & CalcAge < 16 ~ "Male, 11-15y",
      Sex == "Female" & CalcAge >= 2 & CalcAge < 5 ~ "Female, 2-4y",
      Sex == "Female" & CalcAge >= 5 & CalcAge < 11 ~ "Female, 5-10y", 
      Sex == "Female" & CalcAge >= 11 & CalcAge < 16 ~ "Female, 11-15y",
      TRUE ~ NA)) %>%
  relocate(age_sex_cat, .after = Sex)

# DRVs age group
df.survey <- df.survey %>%
  mutate(
    age_sex_cat_drv = case_when(
      Sex == "Male" & CalcAge >= 2 & CalcAge < 4 ~ "Male, 2-3y",
      Sex == "Male" & CalcAge >= 4 & CalcAge < 7 ~ "Male, 4-6y",
      Sex == "Male" & CalcAge >= 7 & CalcAge < 11 ~ "Male, 7-10y", 
      Sex == "Male" & CalcAge >= 11 & CalcAge < 15 ~ "Male, 11-14y",
      Sex == "Male" & CalcAge >= 15 ~ "Male, 15y",
      Sex == "Female" & CalcAge >= 2 & CalcAge < 4 ~ "Female, 2-3y",
      Sex == "Female" & CalcAge >= 4 & CalcAge < 7 ~ "Female, 4-6y",
      Sex == "Female" & CalcAge >= 7 & CalcAge < 11 ~ "Female, 7-10y", 
      Sex == "Female" & CalcAge >= 11 & CalcAge < 15 ~ "Female, 11-14y",
      Sex == "Female" & CalcAge >= 15 ~ "Female, 15y",
      TRUE ~ NA)) %>%
  relocate(age_sex_cat_drv, .after = age_cat_drv)
```

## Number of adults in household group
```{r}
df.survey <- df.survey %>%
  mutate(
    adults_cat = case_when(
      HhldAdults == 1 ~ "1",
      HhldAdults == 2  ~ "2", 
      HhldAdults >= 3 ~ "3 or more",
      TRUE ~ NA)) %>%
  relocate(adults_cat, .after = HhldAdults)
```

## Number of children in household group
```{r}
df.survey <- df.survey %>%
  mutate(
    children_cat = case_when(
      HhldChildren == 1 ~ "1",
      HhldChildren == 2  ~ "2", 
      HhldChildren >= 3 ~ "3 or more",
      TRUE ~ NA)) %>%
  relocate(children_cat, .after = HhldChildren)
```

## Number of siblings in sample
```{r}
df.survey %>%
  filter(grepl("^3", UserID)) %>% #filter UserIDs starting with 3, ^ indicates 'starts with'
  summarise(count = n_distinct(UserID)) #180 siblings in the final dataset
```

## 'RecallNo' and 'NumberOfRecalls'
```{r include=FALSE}
# RecallNo

# Separate date from date and time variable
df.intake24_item$date<-lubridate::date(df.intake24_item$'FinishTime')
  
# Drop duplicate dates for each participant so we have one line per recall date per participant
df.intake24_uniquetime <- df.intake24_item %>%
  distinct(UserID, date, .keep_all = TRUE)
  
# Index the row numbers to create RecallNo variable
df.intake24_uniquetime <- df.intake24_uniquetime %>%
  group_by(UserID) %>% 
  arrange(UserID, date) %>%
  mutate(RecallNo = row_number())%>%
  ungroup()

df.intake24_uniquetime$RecallNo <- as.numeric(df.intake24_uniquetime$RecallNo)

# NumberOfRecalls
    
# Participant's max RecallNo is their number of recalls
df.intake24_uniquetime <- df.intake24_uniquetime %>%
  group_by(UserID) %>%
  mutate(NumberOfRecalls = max(RecallNo, na.rm = TRUE)) %>%
  ungroup()

# Pull out newly created variables and join with intake24 dataset
df.intake24_recallvariables <-  df.intake24_uniquetime  %>%
  select(UserID, date, RecallNo, NumberOfRecalls)
  
df.intake24_item <- left_join(df.intake24_item, df.intake24_recallvariables, by= c("UserID", "date"))

# relocate variables 
df.intake24_item <- df.intake24_item %>%
  relocate(RecallNo, NumberOfRecalls, date, .after = FinishTime)

# remove dataframes that are no longer needed
rm(df.intake24_uniquetime, df.intake24_recallvariables)
```

## 'NumberOfItems' 
Indicates the number of items in each recall. 
```{r include=FALSE}
df.intake24_item <- df.intake24_item %>%
  group_by(UserID, RecallNo) %>%
  mutate(NumberOfItems = n()) %>%
  ungroup()

df.intake24_item <- df.intake24_item %>%
  relocate(NumberOfItems, .after = NumberOfRecalls)
```

## Day of the week recall completed
```{r echo=FALSE}
df.intake24_item$DayofWeek <- weekdays(df.intake24_item$date) 

df.intake24_item <- df.intake24_item %>%
  relocate(DayofWeek, .after = date)

#set factor levels so order is easy to read
df.intake24_item$DayofWeek <- factor(df.intake24_item$DayofWeek, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
```

## Meal types
We are interested in Breakfast, Lunch, Dinner, and Snacks. Participants can choose their own meal name or pick from a drop down. For any meal names not already in one of our described categories, we re-categorised the meal name based on the time of the meal. We investigate the time of meals that already report one of our categories in order to determine the time splits for our meal categories. 

Based on this investigation, meal times for our sample are as follows:
Breakfast: 5 - 9:59
Snack: 10 - 11:59
Lunch: 12 - 13:30
Snack: 13:31 - 16:59
Dinner: 17 - 19:59
Snack: 20 - 4:59

```{r echo=FALSE, message=FALSE, warning=FALSE}
# update meal time variable from excel format to date and time
df.intake24_item$MealTime <- as.POSIXct(df.intake24_item$MealTime, origin = "1970-01-01", tz = "UTC")

df.intake24_item$MealTime_hour <- hour(df.intake24_item$'MealTime')
df.intake24_item$MealTime_minute <- minute(df.intake24_item$'MealTime')

df.intake24_item <- df.intake24_item %>%
  mutate(NewMealTime = paste0(MealTime_hour,":", MealTime_minute))

df.intake24_item <- df.intake24_item %>%
  relocate(NewMealTime, .after = MealTime)

df.intake24_item$MealTime_hour <- as.numeric(df.intake24_item$MealTime_hour)
df.intake24_item$MealTime_minute <- as.numeric(df.intake24_item$MealTime_minute)

# re-categorise meals into meal categories. If mealname is not one of Breakfast, Lunch, Dinner, or Snack, rename based on meal time 
df.intake24_item <- df.intake24_item %>%
  mutate(NewMealName = case_when(
    grepl("snack", MealName, ignore.case = TRUE) ~ 'Snack', #first categorise any inputs with 'snack' in name to snack
    grepl("evening meal", MealName, ignore.case = TRUE) ~ 'Dinner', 
    grepl("dietary supplements", MealName, ignore.case = TRUE) ~ 'Other',
    MealName %in% c('Breakfast', 'Lunch', 'Dinner', 'Snack') ~ MealName, #keep these categories the same
    between(MealTime_hour, 5,9)  ~ "Breakfast", #re-assign meals to categories based on time
    (MealTime_hour == 12 | (MealTime_hour == 13 & MealTime_minute <= 30)) ~ "Lunch", 
    between(MealTime_hour, 17,19)  ~ "Dinner",
    between(MealTime_hour, 10,11) ~ "Snack",
    ((MealTime_hour == 13 & MealTime_minute > 30) | between(MealTime_hour, 14,16)) ~ "Snack",
    (MealTime_hour >= 20 & MealTime_hour <=23) | (MealTime_hour >= 0 & MealTime_hour <= 4) ~ "Snack",
    TRUE ~ MealName)) 

df.intake24_item <- df.intake24_item %>%
  relocate(NewMealName, .after = MealName)
```

## Main Food Groups
```{r}
df.intake24_item <- df.intake24_item %>%
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode %in% c("1C", "1D", "1E", "1F", "1G", "1R") ~ 1,
        SubFoodGroupCode=="2R" ~ 2,
        SubFoodGroupCode=="3R" ~ 3,
        SubFoodGroupCode=="59R" ~ 59,
        SubFoodGroupCode %in% c("4A", "4R") ~ 4,
        SubFoodGroupCode=="5R" ~ 5,
        SubFoodGroupCode=="6R" ~ 6,
        SubFoodGroupCode %in% c("7A", "7B") ~ 7,
        SubFoodGroupCode %in% c("8B", "8C", "8D", "8E") ~ 8,
        SubFoodGroupCode %in% c("9C", "9D", "9E", "9F", "9G", "9H") ~ 9,
        SubFoodGroupCode=="10R" ~ 10,
        SubFoodGroupCode=="11R" ~ 11,
        SubFoodGroupCode=="60R" ~ 60,
        SubFoodGroupCode=="12R" ~ 12,
        SubFoodGroupCode %in% c("13A", "13B", "13R") ~ 13,
        SubFoodGroupCode %in% c("14A", "14B", "14R") ~ 14,
        SubFoodGroupCode %in% c("15B", "15C", "15D") ~ 15,
        SubFoodGroupCode=="53R" ~ 53,
        SubFoodGroupCode %in% c("16C", "16D") ~ 16,
        SubFoodGroupCode=="17R" ~ 17,
        SubFoodGroupCode %in% c("18A", "18B") ~ 18,
        SubFoodGroupCode %in% c("19A", "19R") ~ 19,
        SubFoodGroupCode %in% c("20A", "20B", "20C") ~ 20,
        SubFoodGroupCode %in% c("21A", "21B") ~ 21,
        SubFoodGroupCode %in% c("22A", "22B") ~ 22,
        SubFoodGroupCode %in% c("23A", "23B") ~ 23,
        SubFoodGroupCode %in% c("24A", "24B") ~ 24,
        SubFoodGroupCode %in% c("25A", "25B") ~ 25,
        SubFoodGroupCode %in% c("26A", "26B") ~ 26,
        SubFoodGroupCode %in% c("27A", "27B") ~ 27,
        SubFoodGroupCode=="28R" ~ 28,
        SubFoodGroupCode=="29R" ~ 29,
        SubFoodGroupCode %in% c("30A", "30B") ~ 30,
        SubFoodGroupCode %in% c("31A", "31B") ~ 31,
        SubFoodGroupCode %in% c("32A", "32B") ~ 32,
        SubFoodGroupCode=="33R" ~ 33,
        SubFoodGroupCode %in% c("34C", "34D", "34E", "34F", "34G", "34H") ~ 34,
        SubFoodGroupCode %in% c("35A", "35B") ~ 35,
        SubFoodGroupCode %in% c("36A", "36B", "36C") ~ 36,
        SubFoodGroupCode %in% c("37A", "37B", "37C", "37D", "37E", "37F", "37I", "37K", "37L", "37M") ~ 37,
        SubFoodGroupCode %in% c("38A", "38C", "38D") ~ 38,
        SubFoodGroupCode %in% c("39A", "39B") ~ 39,
        SubFoodGroupCode=="42R" ~ 42,
        SubFoodGroupCode=="56R" ~ 56,
        SubFoodGroupCode %in% c("40A", "40B", "40C", "40D", "40E", "40R") ~ 40,
        SubFoodGroupCode  %in% c("41A", "41B", "41R") ~ 41,
        SubFoodGroupCode=="43R" ~ 43,
        SubFoodGroupCode=="44R" ~ 44,
        SubFoodGroupCode  %in% c("45R", "61R") ~ 45,
        SubFoodGroupCode %in% c("57A", "57B", "57C") ~ 57,
        SubFoodGroupCode %in% c("58A", "58B", "58C") ~ 58,
        SubFoodGroupCode %in% c("51A", "51B", "51C", "51D", "51R") ~ 51,
        SubFoodGroupCode %in% c("47A", "47B") ~ 47,
        SubFoodGroupCode %in% c("48A", "48B", "48C") ~ 48,
        SubFoodGroupCode %in% c("49A", "49B", "49C", "49D", "49E") ~ 49,
        SubFoodGroupCode %in% c("50A", "50C", "50D", "50E", "50R") ~ 50,
        SubFoodGroupCode %in% c("52A", "52R") ~ 52,
        SubFoodGroupCode %in% c("54A", "54B", "54C", "54D", "54E", "54F", "54G", "54H", "54I", "54J", "54K", "54L", "54M", "54N", "54P") ~ 54,
        SubFoodGroupCode=="55R" ~ 55,
        SubFoodGroupCode=="62R" ~ 62,
        TRUE ~ NA)) %>%
        relocate(MainFoodGroupCode, .after = FoodGroupEnglish)

# Create Main Food Group description variable
    df.intake24_item <- df.intake24_item %>%
      mutate(MainFoodGroupDesc = case_when(
        MainFoodGroupCode == 1 ~ "Pasta, rice and other miscellaneous cereals",
        MainFoodGroupCode == 2 ~ "White bread",
        MainFoodGroupCode == 3 ~ "Wholemeal bread",
        MainFoodGroupCode == 4 ~ "Other breads",
        MainFoodGroupCode == 5 ~ "High fibre breakfast cereals",
        MainFoodGroupCode == 6 ~ "Other breakfast cereals",
        MainFoodGroupCode == 7 ~ "Biscuits",
        MainFoodGroupCode == 8 ~ "Buns, cakes, pastries and fruit pies",
        MainFoodGroupCode == 9 ~ "Puddings",
        MainFoodGroupCode == 10 ~ "Whole milk",
        MainFoodGroupCode == 11 ~ "Semi-skimmed milk",
        MainFoodGroupCode == 12 ~ "Skimmed milk",
        MainFoodGroupCode == 13 ~ "Other milk and cream",
        MainFoodGroupCode == 14 ~ "Cheese",
        MainFoodGroupCode == 15 ~ "Yogurt, fromage frais and other dairy desserts",
        MainFoodGroupCode == 16 ~ "Eggs and egg dishes",
        MainFoodGroupCode == 17 ~ "Butter",
        MainFoodGroupCode == 18 ~ "Polyunsaturated margarine and oils",
        MainFoodGroupCode == 19 ~ "Low fat spread",
        MainFoodGroupCode == 20 ~ "Margarine and other cooking fats and oils NOT polyunsaturated",
        MainFoodGroupCode == 21 ~ "Reduced fat spread",
        MainFoodGroupCode == 22 ~ "Bacon and ham",
        MainFoodGroupCode == 23 ~ "Beef, veal and dishes",
        MainFoodGroupCode == 24 ~ "Lamb and dishes",
        MainFoodGroupCode == 25 ~ "Pork and dishes",
        MainFoodGroupCode == 26 ~ "Coated chicken and turkey manufactured",
        MainFoodGroupCode == 27 ~ "Chicken and turkey dishes",
        MainFoodGroupCode == 28 ~ "Liver, products and dishes",
        MainFoodGroupCode == 29 ~ "Burgers and kebabs",
        MainFoodGroupCode == 30 ~ "Sausages",
        MainFoodGroupCode == 31 ~ "Meat pies and pastries",
        MainFoodGroupCode == 32 ~ "Other meat and meat products",
        MainFoodGroupCode == 33 ~ "White fish coated or fried",
        MainFoodGroupCode == 34 ~ "Other white fish, shellfish and fish dishes",
        MainFoodGroupCode == 35 ~ "Oily fish",
        MainFoodGroupCode == 36 ~ "Salad and other raw vegetables",
        MainFoodGroupCode == 37 ~ "Vegetables (not raw)",
        MainFoodGroupCode == 38 ~ "Chips, fried and roast potatoes and potato products",
        MainFoodGroupCode == 39 ~ "Other potatoes, potato salads and dishes",
        MainFoodGroupCode == 40 ~ "Fruit",
        MainFoodGroupCode == 41 ~ "Sugars, preserves and sweet spreads",
        MainFoodGroupCode == 42 ~ "Crisps and savoury snacks",
        MainFoodGroupCode == 43 ~ "Sugar confectionery",
        MainFoodGroupCode == 44 ~ "Chocolate confectionery",
        MainFoodGroupCode == 45 ~ "Fruit juice",
        MainFoodGroupCode == 47 ~ "Spirits and liqueurs",
        MainFoodGroupCode == 48 ~ "Wine",
        MainFoodGroupCode == 49 ~ "Beer lager cider and perry",
        MainFoodGroupCode == 50 ~ "Miscellaneous",
        MainFoodGroupCode == 51 ~ "Tea, coffee and water",
        MainFoodGroupCode == 52 ~ "Commercial toddlers foods and drinks",
        MainFoodGroupCode == 53 ~ "Ice cream",
        MainFoodGroupCode == 54 ~ "Dietary supplements",
        MainFoodGroupCode == 55 ~ "Artificial sweeteners",
        MainFoodGroupCode == 56 ~ "Nuts and seeds",
        MainFoodGroupCode == 57 ~ "Soft drinks, not diet",
        MainFoodGroupCode == 58 ~ "Soft drinks, diet",
        MainFoodGroupCode == 59 ~ "Brown, granary and wheatgerm bread",
        MainFoodGroupCode == 60 ~ "1% Milk",
        MainFoodGroupCode == 62 ~ "Sandwiches",
        MainFoodGroupCode == 63 ~ "Other milk and cream DF",                         
        MainFoodGroupCode == 64 ~ "Cheese DF",
        MainFoodGroupCode == 65 ~ "Yogurt, fromage frais and other dairy desserts DF",
        MainFoodGroupCode == 66 ~ "Ice cream DF",
        TRUE ~ NA)) %>%
      relocate(MainFoodGroupDesc, .after = MainFoodGroupCode)
```

## Discretionary Food Groups 
We're reporting intakes of the following discretionary food groups:

Sweet biscuits
Cakes, sweet pastries & puddings
Crisps & savoury snacks
Confectionery
Ice cream & ice lollies
Sugar-containing soft drinks
Breakfast cereals
Roast potatoes, chips and similar roasted potato products
Pizza
Yoghurts, fromage frais and dairy desserts
Ready meals

```{r}
#re-categorise discretionary foods 

# biscuits
biscuits <- df.intake24_item %>% 
  filter(MainFoodGroupCode == 7) %>% 
  select(NutrientTableCode, Description_English) %>%
  distinct(NutrientTableCode, .keep_all = TRUE)

#write.xlsx(biscuits, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Biscuits_280824.xlsx")

biscuits_exclude_list <- c("7649","251","252","3973","7650","8330","258","256","255","273","3267","266","267","3236","279","10062","11242","274","7652")


# crisps and savoury snacks 
crisps <- df.intake24_item %>% 
  filter(MainFoodGroupCode == 42) %>% 
  select(NutrientTableCode, Description_English) %>%
  distinct(NutrientTableCode, .keep_all = TRUE)

#write.xlsx(crisps, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Crisps_280824.xlsx")

crisps_exclude_list <- c("8033","8155","7876")
crisps_include_list <- c("11499","2269","11607") #popcorns


# confectionery
confectionery <- df.intake24_item %>% 
  filter(MainFoodGroupCode == 43 | MainFoodGroupCode == 44) %>% 
  select(NutrientTableCode, Description_English) %>%
  distinct(NutrientTableCode, .keep_all = TRUE)

#write.xlsx(confectionery, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Confectionery_280824.xlsx")

confectionery_exclude_list <- c("7762", "2262","11499","2269","11607")
lollies_inclued_list <- c("7762", "2262")


# breakfast cereals
bfastcereals <- df.intake24_item %>% 
  filter(MainFoodGroupCode == 5 | MainFoodGroupCode == 6) %>% 
  select(NutrientTableCode, Description_English) %>%
  distinct(NutrientTableCode, .keep_all = TRUE)

#write.xlsx(bfastcereals, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Breakfast_Cereals_280824.xlsx")

# **TO UPDATE BASED ON RESPONSE FROM FSS**
#bfastcereals_exclude_list <- c("8853","5331","8756","3797","3925","3210","10284","10338","11125","3421","219")


# roast potatoes, chips and similar roasted potato products
potatoes <- df.intake24_item %>% 
  filter(MainFoodGroupCode == 39) %>% 
  select(NutrientTableCode, Description_English) %>%
  distinct(NutrientTableCode, .keep_all = TRUE)

#write.xlsx(potatoes, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/Potatoes_280824.xlsx")

potatoes_include_list <- c("5065","11493")


# ready meals  
readymeals <- df.intake24_item %>% 
  filter(SubFoodGroupCode == "1D" | SubFoodGroupCode == "1F" | SubFoodGroupCode == "16C" | SubFoodGroupCode == "22A" 
         | SubFoodGroupCode == "23A" | SubFoodGroupCode == "24A" | SubFoodGroupCode == "25A" | SubFoodGroupCode == "26A"
         | SubFoodGroupCode == "27A" | SubFoodGroupCode == "30A" | SubFoodGroupCode == "31A" | SubFoodGroupCode == "32A"
         | SubFoodGroupCode == "34C" | SubFoodGroupCode == "34E" | SubFoodGroupCode == "34G" | SubFoodGroupCode == "35A"
         | MainFoodGroupCode == "37" | SubFoodGroupCode == "39A" | SubFoodGroupCode == "50C") %>% 
  select(MainFoodGroupCode, SubFoodGroupCode, NutrientTableCode, Description_English) %>%
  distinct(NutrientTableCode, .keep_all = TRUE)

#write.xlsx(readymeals, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/ReadyMeals_280824.xlsx")

readymeal_include_list <- c("8049","9245","3187","1347","9386","9244","8666","4283","6393","5321","7094","9318","9270","1116","5627","8286","9726","5313")


# Create discretionary food groups 
df.intake24_item <- df.intake24_item %>% 
 mutate(DiscretionaryFoodGroupCode = case_when (
   # Sweet biscuits
   MainFoodGroupCode == 7 & !NutrientTableCode %in% c(biscuits_exclude_list) ~ 1,
   # Cakes, sweet pastries & puddings
   MainFoodGroupCode == 8 | MainFoodGroupCode == 9 ~ 2,
   # Crisps and savoury snacks
   (MainFoodGroupCode == 42 | NutrientTableCode %in% c(crisps_include_list)) & 
     !NutrientTableCode %in% c(crisps_exclude_list) ~ 3,
   # Confectionery
   (MainFoodGroupCode == 43 | MainFoodGroupCode == 44) & !NutrientTableCode %in% c(confectionery_exclude_list) ~ 4,
   # Ice creams & ice lollies
   MainFoodGroupCode == 53 | NutrientTableCode %in% c(lollies_inclued_list) ~ 5,
   # Sugar-containing soft drinks
   MainFoodGroupCode == 57 ~ 6,
   # Breakfast cereals
   MainFoodGroupCode == 5 | MainFoodGroupCode == 6 ~ 7,
   # Roast potatoes, chips and similar roasted potato products
   MainFoodGroupCode == 38 | NutrientTableCode %in% c(potatoes_include_list) ~ 8,
   # Pizza
   SubFoodGroupCode == "1C" ~ 9,
   # Yoghurts, fromage frais and dairy desserts
   MainFoodGroupCode == 15 ~ 10,
   # Ready meals
   NutrientTableCode %in% c(readymeal_include_list) ~ 11,
   TRUE ~ NA))

# Add description variable
df.intake24_item <- df.intake24_item %>%
  mutate(DiscretionaryFoodGroupDesc = case_when(
    DiscretionaryFoodGroupCode == 1 ~ "Sweet biscuits",
    DiscretionaryFoodGroupCode == 2 ~ "Cakes, sweet pastries & puddings",
    DiscretionaryFoodGroupCode == 3 ~ "Crisps and savoury snacks",
    DiscretionaryFoodGroupCode == 4 ~ "Confectionery",
    DiscretionaryFoodGroupCode == 5 ~ "Ice creams & ice lollies",
    DiscretionaryFoodGroupCode == 6 ~ "Sugar-containing soft drinks",
    DiscretionaryFoodGroupCode == 7 ~ "Breakfast cereals",
    DiscretionaryFoodGroupCode == 8 ~ "Roast potatoes, chips and similar roasted potato products",
    DiscretionaryFoodGroupCode == 9 ~ "Pizza",
    DiscretionaryFoodGroupCode == 10 ~ "Yoghurts, fromage frais and dairy desserts",
    DiscretionaryFoodGroupCode == 11 ~ "Ready meals",
    TRUE ~ "Other")) %>%
  
  relocate(DiscretionaryFoodGroupCode, DiscretionaryFoodGroupDesc, .after = MainFoodGroupDesc)

# remove dataframes that are no longer needed
rm(biscuits, crisps, confectionery, bfastcereals, potatoes, readymeals)
```

## Device intake24 completed on
```{r include=FALSE}
df.intake24_item <- df.intake24_item %>%
  mutate(Device_group = ifelse(grepl("Android|iPhone", Device), "phone", ifelse(grepl("iPad", Device), "ipad", "computer"))
  )

df.intake24_item <- df.intake24_item %>%
  relocate(Device_group, .after = Device)
```

# **TO UPDATE** Re-code missing foods
Food items entered using the ‘Report a missing food’ function will be manually coded and linked to appropriate nutritional information from the NDNS Nutrient Databank 
```{r}
#Create a subset to look at the Missing Food Items to manually code and link to nutritional information
df.intake24_missing_food <- df.intake24_item %>%
  subset(df.intake24_item$MissingFoodID != "N/A")

```

```{r eval=FALSE, include=FALSE}
write.csv(df.intake24_missing_food, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/Missing_Food_Codes_050924.csv")
```

# Remove diet supplements and breast milk
```{r}
# Remove diet supplements
supplements <- df.intake24_item %>%
  filter(MainFoodGroupCode == "54")

df.intake24_item <- df.intake24_item %>%
      filter(MainFoodGroupCode != "54")

# Remove breast milk
breast_milk <- df.intake24_item %>%
  filter(Description_English =="Breast milk")

df.intake24_item <- df.intake24_item %>%
  filter(Description_English != "Breast milk") 

rm(supplements, breast_milk)
```

# Clean up dairy food groups
## Remove dairy-free items from milk product subfood groups
```{r}
#Sub food group level
    # Other milk
    df.intake24_item <- df.intake24_item %>%  
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "13R" &
            (str_detect(Description_English, regex("Almond", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Alpro", ignore_case = TRUE)) |
             str_detect(Description_English, regex("soya", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Hemp", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Oat", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Rice", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Coconut", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Dairy free", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Hazelnut", ignore_case = TRUE))) ~ "13R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Cream
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "13B" & 
          str_detect(Description_English, regex("Alpro", ignore_case = TRUE)) ~ "13B_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Other cheese
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "14R" & 
          (str_detect(Description_English, regex("Tofu", ignore_case = TRUE))|
          str_detect(Description_English, regex("Coconut", ignore_case = TRUE))) ~ "14R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Yogurt
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "15B" & 
          (str_detect(Description_English, regex("Soya", ignore_case = TRUE)) | 
           str_detect(Description_English, regex("Coconut", ignore_case = TRUE)) |
           str_detect(Description_English, regex("oat", ignore_case = TRUE))  ) ~ "15B_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Fromage frais and other dairy desserts 
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "15C" & 
          str_detect(Description_English, regex("Soya", ignore_case = TRUE)) ~ "15C_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Ice cream
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "53R" &
          str_detect(Description_English, regex("Dairy free", ignore_case = TRUE)) ~ "53R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Main food group level
    df.intake24_item <- df.intake24_item %>% 
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode == "13R_DF" ~ 63,
        SubFoodGroupCode == "13B_DF" ~ 63,
        SubFoodGroupCode == "14R_DF" ~ 64,
        SubFoodGroupCode == "15B_DF" ~ 65,
        SubFoodGroupCode == "15C_DF" ~ 65,
        SubFoodGroupCode == "53R_DF" ~ 66,
        TRUE ~ MainFoodGroupCode))
    
```

## Remove hot chocolate made with water
```{r}
# Sub food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        str_detect(Description_English, regex("Hot chocolate, made with water", ignore_case=TRUE)) ~ "50A",
        TRUE ~ SubFoodGroupCode)) 
    
    # Main food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode == "50A" ~ 50,
        TRUE ~ MainFoodGroupCode))

# Move milky coffees into 'other milk'
    
    #Sub food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "51A" &
          (str_detect(Description_English, regex("Cappuccino", ignore_case = TRUE)) | 
             str_detect(Description_English, regex("Latte", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Flat white", ignore_case = TRUE)) |
             str_detect(Description_English, regex("Mocha", ignore_case = TRUE))) ~ "13R",
        TRUE ~ SubFoodGroupCode))
```

## Re-categorise dairy-free coffees out of 'other milk'
```{r}
# Sub food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(SubFoodGroupCode = case_when(
        SubFoodGroupCode == "13R" &
          str_detect(Description_English, regex("soya milk", ignore_case = TRUE)) ~ "13R_DF",
        TRUE ~ SubFoodGroupCode))
    
    # Main food group
    df.intake24_item <- df.intake24_item %>% 
      mutate(MainFoodGroupCode = case_when(
        SubFoodGroupCode == "13R" ~ 13,
        TRUE ~ MainFoodGroupCode))
    
    #Manual code check: for dairy-free items
    df.dairy_free <- df.intake24_item %>% 
      filter(SubFoodGroupCode == "13R" | SubFoodGroupCode == "13B" | SubFoodGroupCode == "14R" | SubFoodGroupCode == "15B" | SubFoodGroupCode == "15C" | SubFoodGroupCode == "53R")  
    df.dairy_free <- df.dairy_free %>% distinct(Description_English, .keep_all = TRUE)  
  
rm(df.dairy_free)
```

## Food Group Descriptions
```{r}
Descriptions <- df.intake24_item %>%
  count(MainFoodGroupDesc, MainFoodGroupCode,Description_English, SubFoodGroupCode, DiscretionaryFoodGroupDesc, DiscretionaryFoodGroupCode, NutrientTableCode)
```

```{r eval=FALSE, include=FALSE}
write.csv(Descriptions, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/Food_groups_060924.csv")
```

# Convert variables to numeric and replace NAs with 0s
```{r include=FALSE}
#convert to numeric from characters

# List of variables to not convert
    char_not_to_convert <- c("SurveyID", "UserID", "Device", "Device_group", "StartTime", "FinishTime", "SurveyDuration", "date", "DayofWeek", "FoodAmount", "FoodAmountReason", "MealName", "NewMealName", "MealTime", "NewMealTime", "FoodSource", "SearchTerm", "Intake24FoodCode", "Description_English", "Description_Local", "FoodGroupCode", "FoodGroupEnglish", "MainFoodGroupDesc", "AsServedWeightFactor", "SubFoodGroupCode", "DiscretionaryFoodGroupDesc", "ReadyMeal",  "MissingFoodID", "MissingFoodDescription", "MissingFoodPortionSize", "MissingFoodLeftovers")
    
    df.intake24_item <- df.intake24_item %>%
      mutate(across(-all_of(char_not_to_convert), as.numeric))
    
# Change NA values to 0
  df.intake24_item <- df.intake24_item %>%
      mutate(across(-all_of(char_not_to_convert), ~ifelse(is.na(.), 0, .)))
```

# Create new nutrient variables
```{r}
# Create food energy (kcal) variable
    df.intake24_item <- df.intake24_item %>%
      mutate(FoodEnergy = Energykcal - (Alcoholg*7)) %>%
      relocate(FoodEnergy, .after = Energykcal)
    
    # Create food energy milk (kcal) variable - removes all kcals from non-milk beverages
    df.intake24_item <- df.intake24_item %>%                
      mutate(FoodMilkEnergy = case_when(
        MainFoodGroupCode %in% c(45, 51, 57, 58) ~  0,
        TRUE ~ FoodEnergy)) %>%
      relocate(FoodMilkEnergy, .after = FoodEnergy)
    
  # Create food grams variable
    df.intake24_item <- df.intake24_item %>%
      mutate(FoodGrams = TotalGrams - Alcoholg) %>%
      relocate(FoodGrams, .after = TotalGrams)
    
  # Create food grams milk variable
    df.intake24_item <- df.intake24_item %>%                
      mutate(FoodMilkGrams = case_when(
        FoodMilkEnergy == 0 ~ 0,
        TRUE ~ FoodGrams
      )) %>%
      relocate(FoodMilkGrams, .after = FoodGrams)
    
 # Calculate calories from macronutrients (kcal)
    df.intake24_item <- df.intake24_item %>%
      mutate(
        Carbs_kcal = (Carbohydrateg*3.75),
        Freesugars_kcal = (Freesugarsg*3.75), 
        Fat_kcal = (Fatg*9),
        SatFat_Kcal = (Saturatedfattyacidsg*9),
        TransFat_Kcal = (Transfattyacidsg*9),
        Protein_kcal = (Proteing*4),
        Alcohol_kcal = (Alcoholg*7),)  %>%
        relocate(Carbs_kcal, .after = Carbohydrateg) %>%
        relocate(Freesugars_kcal, .after = Freesugarsg) %>%
        relocate(Fat_kcal, .after = Fatg) %>%
        relocate(SatFat_Kcal, .after = Saturatedfattyacidsg) %>%
        relocate(TransFat_Kcal, .after = Transfattyacidsg) %>%
        relocate(Protein_kcal, .after = Proteing) %>%
        relocate(Alcohol_kcal, .after = Alcoholg)
    
  # Calculate salt from sodium 
    df.intake24_item <- df.intake24_item %>%
      mutate(
        Saltg = ((Sodiummg/1000)*2.498)
      ) %>%
      relocate(Saltg, .after = Sodiummg)
```

# Recalls completed under 2 minutes
```{r}
#remove ' min' from the time to complete column and convert to numeric value
df.intake24_item$SurveyDuration <- as.numeric(str_remove(df.intake24_item$SurveyDuration, " min"))

#examine recalls completed in less than 2 minutes for completeness
under_2min <- df.intake24_item %>%
  filter(SurveyDuration <= 2)

n_distinct(under_2min$UserID)

#write.xlsx(under_2min, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/two_minutes_check_280824.xlsx")
#write.xlsx(under_2min, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/two_minutes_check_280824.xlsx")

rm(under_2min)

# remove recalls that didn't pass quality check
df.intake24_item <- df.intake24_item %>%
  filter(!(UserID == 10008833 & RecallNo == 2))

df.intake24_item <- df.intake24_item %>%
  filter(!(UserID == 10000459 & RecallNo == 3))
```

# Recalls with fewer than 5 items
```{r include=FALSE}
#create a subset of all responses that have 5 or fewer responses to check 
food_count_5 <- df.intake24_item %>%
  filter(NumberOfItems <= 5)

n_distinct(food_count_5$UserID)

#write.xlsx(food_count_5, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/five_items_check_280824.xlsx")
#write.xlsx(food_count_5, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Output/five_items_check_280824.xlsx")

rm(food_count_5)

# remove recalls that didn't pass quality check
df.intake24_item <- df.intake24_item %>%
  filter(!(UserID == 10013179 & RecallNo == 2))

df.intake24_item <- df.intake24_item %>%
  filter(!(UserID == 10012849 & RecallNo == 1)) 
```

# Create sample characteristics data frame
```{r}
df.char <- df.survey %>%
  select("UserID", "HouseholdID", "psu", "Age", "age_cat", "Sex", "age_sex_cat", "age_cat_drv", "age_sex_cat_drv", "Ethnicity", "simd_quintile", "Education", "adults_cat", "children_cat", "FoodParcels")
```

# Merge sample characteristics with intake24
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Join intake24 data and survey data
df.intake24_item <- left_join(df.intake24_item, df.char, by = c('UserID'))

# relocate columns for ease in management
df.intake24_item <- df.intake24_item %>%
  relocate(c("HouseholdID", "psu", "Age", "age_cat", "Sex", "age_sex_cat", "age_cat_drv", "age_sex_cat_drv", "Ethnicity", "simd_quintile", "Education", "adults_cat", "children_cat", "FoodParcels"), .after = UserID)

n_distinct(df.intake24_item$UserID)

rm(df.char)

# Drop variables not needed
df.intake24_item <- df.intake24_item %>%
  select(-MealTime, -MealTime_hour, -MealTime_minute, -Device)
```

# Write data frames to CSV files
```{r include=FALSE}
write.csv(df.intake24_item, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/intake24_item_090924.csv")
write.csv(df.survey, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/survey_clean_090924.csv")
write.csv(df.char, file = "/Users/ricki/Desktop/DISH_data_cleaning/Output/participant_characteristics_090924.csv")

#write.csv(df.intake24_item, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Data/intake24_item_280824.csv")
#write.csv(df.survey, file = "C:/Users/ljaacks/OneDrive - University of Edinburgh/Scottish Diets/_National Monitoring of Diet Scotland/3_DISH/Analysis/Data/survey_clean_280824.csv")
```
